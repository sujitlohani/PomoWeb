{% extends "base.html" %}
{% block title %}Home · Pomoweb{% endblock %}
{% block content %}
<div class="grid md:grid-cols-2 gap-8 items-start">
  <!-- Timer Card -->
  <section class="glass-card p-6 sm:p-8 rounded-2xl shadow-soft">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-xl font-semibold tracking-tight">Pomodoro</h1>
      <div class="inline-flex rounded-full bg-slate-100 p-1">
        <button onclick="setMode('pomodoro')" id="mode-pomodoro" class="tab">Focus</button>
        <button onclick="setMode('short')" id="mode-short" class="tab">Short</button>
        <button onclick="setMode('long')" id="mode-long" class="tab">Long</button>
      </div>
    </div>

    <div id="timer" class="text-6xl sm:text-7xl font-semibold tabular-nums text-slate-900 text-center my-6">25:00</div>

    <div class="flex items-center justify-center gap-3">
      <button id="startBtn" onclick="toggleTimer()" class="btn-primary">Start</button>
      <button onclick="resetTimer()" class="btn-outline" title="Reset">Reset</button>
    </div>
  </section>

  <!-- Tasks Card on Home -->
  <section class="glass-card p-6 sm:p-8 rounded-2xl shadow-soft">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">Quick Tasks</h2>
      <button onclick="openTaskModal()" class="btn-ghost">+ Add</button>
    </div>

    <div class="space-y-3">
      {% if tasks %}
        {% for task in tasks %}
          <div class="flex items-center justify-between bg-white/70 rounded-xl border border-slate-200 p-3">
            <div class="flex items-center gap-3">
              <form method="POST" action="{{ url_for('toggle_task', task_id=task.id) }}">
                <button type="submit" class="h-5 w-5 rounded-full border border-slate-300 flex items-center justify-center">
                  {% if task.completed %}
                    <span class="h-3 w-3 rounded-full bg-accent-500 inline-block"></span>
                  {% endif %}
                </button>
              </form>
              <span class="{% if task.completed %}line-through text-slate-400{% endif %}">{{ task.description }}</span>
            </div>
            <form method="POST" action="{{ url_for('delete_task', task_id=task.id) }}">
              <button class="text-slate-500 hover:text-red-600" title="Delete">Delete</button>
            </form>
          </div>
        {% endfor %}
      {% else %}
        <p class="text-slate-500">No tasks yet. Add your first focus item.</p>
      {% endif %}
    </div>

    <div class="mt-5 text-right">
      <a href="{{ url_for('tasks') }}" class="text-sm text-slate-600 hover:text-slate-900 underline-offset-4 hover:underline">Open full task list →</a>
    </div>
  </section>
</div>

<!-- Add Task Modal -->
<div id="taskModal" class="fixed inset-0 z-40 hidden">
  <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" onclick="closeTaskModal()"></div>
  <div class="relative z-10 max-w-md mx-auto mt-28 glass-card rounded-2xl shadow-soft p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold">Add a New Task</h3>
      <button onclick="closeTaskModal()" class="text-slate-500 hover:text-slate-700">Close</button>
    </div>
    <form action="{{ url_for('add_task') }}" method="POST" class="space-y-4">
      <input name="description" type="text" placeholder="What will you focus on?" class="input" required>
      <div class="flex justify-end gap-3">
        <button type="button" onclick="closeTaskModal()" class="btn-outline">Cancel</button>
        <button type="submit" class="btn-primary">Save Task</button>
      </div>
    </form>
  </div>
</div>

<script>
  let mode = "pomodoro";
  let isRunning = false;
  let timerInterval = null;
  let timeLeft = 25 * 60;

  const modeDurations = { pomodoro: 25 * 60, short: 5 * 60, long: 15 * 60 };

  function updateTimerDisplay() {
    const m = String(Math.floor(timeLeft / 60)).padStart(2, '0');
    const s = String(timeLeft % 60).padStart(2, '0');
    document.getElementById('timer').textContent = `${m}:${s}`;
  }

  function setMode(newMode) {
    mode = newMode; resetTimer(); highlightModeButton();
  }

  function highlightModeButton() {
    document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active-tab'));
    const active = document.getElementById(`mode-${mode}`);
    active.classList.add('active-tab');
  }

  function toggleTimer() {
    const startBtn = document.getElementById('startBtn');
    if (!isRunning) {
      isRunning = true; startBtn.textContent = 'Pause';
      timerInterval = setInterval(() => {
        if (timeLeft > 0) { timeLeft--; updateTimerDisplay(); }
        else { clearInterval(timerInterval); isRunning = false; startBtn.textContent = 'Start'; alert("Time's up"); }
      }, 1000);
    } else { clearInterval(timerInterval); isRunning = false; startBtn.textContent = 'Start'; }
  }

  function resetTimer() { clearInterval(timerInterval); isRunning = false; timeLeft = modeDurations[mode]; updateTimerDisplay(); document.getElementById('startBtn').textContent = 'Start'; }

  function openTaskModal(){ document.getElementById('taskModal').classList.remove('hidden'); }
  function closeTaskModal(){ document.getElementById('taskModal').classList.add('hidden'); }

  highlightModeButton();
  updateTimerDisplay();
</script>
{% endblock %}