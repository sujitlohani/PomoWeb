{% extends "base.html" %}

{% block content %}
<div class="flex min-h-screen">

  <aside class="w-64 bg-gray-800 text-white flex flex-col">
    <div class="p-6 text-2xl font-bold border-b border-gray-700">
      Admin
    </div>

    <div class="p-4 text-sm uppercase tracking-wide text-gray-400">Users</div>
    <nav class="flex-1 px-4 space-y-1 overflow-y-auto">
      {% for u in users %}
        {% if not u.is_admin %}
        <button
          type="button"
          class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400"
          data-user-id="{{ u.id }}"
          data-username="{{ u.username }}"
          data-tasks='{{ tasks_by_user[u.id] | tojson }}'
          onclick="openUserTasks(this)">
          {{ u.username }}
        </button>
        {% endif %}
      {% endfor %}
    </nav>

  </aside>

  <main class="flex-1 bg-gray-50 p-8">
    <h2 class="text-3xl font-semibold text-gray-800 mb-6">Admin Dashboard</h2>

    <div class="bg-white p-6 rounded-lg shadow-lg">
      <h3 class="text-xl font-medium text-gray-700 mb-4">Assign a Task</h3>
      <form method="POST" class="space-y-4">
        <div>
          <label for="user_id" class="block text-gray-600">Assign to User</label>
          <select name="user_id" id="user_id" class="w-full p-3 border border-gray-300 rounded-md">
            {% for user in users %}
              <option value="{{ user.id }}">{{ user.username }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="task_description" class="block text-gray-600">Task Description</label>
          <input type="text" name="task_description" id="task_description" required
                 class="w-full p-3 border border-gray-300 rounded-md"
                 placeholder="Enter task description">
        </div>

        <div class="text-right">
          <button type="submit"
                  class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 focus:outline-none">
            Assign Task
          </button>
        </div>
      </form>
    </div>

    <!-- Assigned Tasks Section -->
    <div class="bg-white p-6 mt-8 rounded-lg shadow-lg">
      <h3 class="text-xl font-medium text-gray-700 mb-4">All Assigned Tasks</h3>
      <ul class="divide-y divide-gray-200">
        {% for task in tasks %}
          <li class="py-4 flex justify-between items-start">
            <div>
              <p class="text-gray-700">
                {{ task.description }}
                — <span class="text-slate-500">Assigned to</span>
                <strong class="text-blue-600">{{ task.user.username }}</strong>
                {% if task.assigned_by_admin %}
                  <span class="ml-2 inline-flex items-center gap-1 text-[11px] px-2 py-0.5 rounded-full bg-amber-100 text-amber-700"
                        title="Assigned by admin">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2l7 3v6c0 5-3.8 8.6-7 9-3.2-.4-7-4-7-9V5l7-3z"/>
                    </svg>
                    admin
                  </span>
                {% endif %}
              </p>
              <p class="text-sm mt-1">
                {% if task.completed %}
                  <span class="text-green-700 font-medium">✔ Completed</span>
                  {% if task.completed_at %}
                    <span class="ml-2 text-slate-500">
                      on {{ task.completed_at.strftime('%Y-%m-%d %H:%M') }}
                    </span>
                  {% endif %}
                {% else %}
                  <span class="text-slate-500">⏳ Pending</span>
                {% endif %}
              </p>
            </div>
            <div>
              {% if task.completed %}
                <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Done</span>
              {% else %}
                <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700">Open</span>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    </div>
  </main>
</div>

<!-- Modal -->
<div id="userTasksModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/50" onclick="closeUserTasks()"></div>
  <div class="relative mx-auto mt-24 w-11/12 max-w-2xl bg-white rounded-xl shadow-2xl">
    <div class="flex justify-between items-center px-6 py-4 border-b">
      <h3 id="modalTitle" class="text-xl font-semibold text-gray-800">User Tasks</h3>
      <button class="p-2 rounded hover:bg-gray-100" onclick="closeUserTasks()"
              aria-label="Close">
        ✕
      </button>
    </div>
    <div id="modalBody" class="p-6">
    </div>
    <div class="px-6 py-4 border-t text-right">
      <button class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700"
              onclick="closeUserTasks()">Close</button>
    </div>
  </div>
</div>

<script>
  function openUserTasks(btn) {
    const username = btn.getAttribute('data-username');
    const tasks = JSON.parse(btn.getAttribute('data-tasks') || "[]");

    document.getElementById('modalTitle').textContent = `Tasks for ${username}`;

    if (!tasks.length) {
      document.getElementById('modalBody').innerHTML =
        `<p class="text-gray-600">No tasks assigned.</p>`;
    } else {
      const items = tasks.map(t => {
        const badge = t.completed
          ? `<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Done</span>`
          : `<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700">Open</span>`;
        return `
          <li class="py-3 flex justify-between">
            <div>
              <p class="font-medium text-gray-800">${t.description}</p>
              ${t.timestamp ? `<p class="text-sm text-gray-500">Created ${t.timestamp}</p>` : ``}
            </div>
            ${badge}
          </li>`;
      }).join('');

      document.getElementById('modalBody').innerHTML =
        `<ul class="divide-y divide-gray-200">${items}</ul>`;
    }

    document.getElementById('userTasksModal').classList.remove('hidden');
  }

  function closeUserTasks() {
    document.getElementById('userTasksModal').classList.add('hidden');
  }
</script>
{% endblock %}
